#Irrigazione Automatica Terrazzo
- id: irrigazione_terrazzo_automatica
  alias: Irrigazione Automatica Terrazzo
  description: "Irriga automaticamente il terrazzo in base alle condizioni meteo"
  trigger:
      - platform: numeric_state
        entity_id: sun.sun
        attribute: elevation
        above: 35
  condition:
  - condition: numeric_state
    entity_id: sensor.meteo_openweathermap_forecast_precipitation
    below: '4'
  - condition: numeric_state
    entity_id: input_number.pioggia_ieri
    below: '4'
  action:
  - entity_id: switch.irrigazione_terrazzo
    service: switch.turn_on
  - delay:
      minutes: >
        {% set t = states('input_number.temperatura_massima_ieri') | float %}
        {{ states('input_number.durata_irrigazione')|int * (3 if t > 29  else 2 if t > 24 else 1 if t > 19 else 0.5) }}
  - entity_id: switch.irrigazione_terrazzo
    service: switch.turn_off
  - service: notify.mobile_app_iphone_christian
    data:
      title: >
        {{ "\U0001FAB4" }} Irrigazione terrazzo
      message: "Attivata per {{ states.sensor.irrigazione_terrazzo_oggi.attributes.value }} minuti"
      
#Temperatura Massima di Oggi
- id: temp_massima_oggi
  alias: Temperatura Massima di Oggi
  description: "Registra il valore massimo della temperatura di oggi"
  trigger:
  - platform: state
    entity_id: sensor.meteo_openweathermap_temperature
  condition:
    condition: numeric_state
    entity_id: sensor.meteo_openweathermap_temperature
    above: input_number.temperatura_massima_oggi
  action:
  - service: input_number.set_value
    data_template:
     entity_id: input_number.temperatura_massima_oggi
     value: "{{ states('sensor.meteo_openweathermap_temperature')|float }}"
    
#Temperatura Massima di Ieri
- id: temp_massima_ieri
  alias: Temperatura Massima di Ieri
  description: "Registra il valore massimo della temperatura di ieri, aggiornandosi alle 23:59 di ogni giorno"
  trigger:
  - platform: time
    at: "23:59:59"
  action:
  - service: input_number.set_value
    data_template:
      entity_id: input_number.temperatura_massima_ieri
      value: "{{states('input_number.temperatura_massima_oggi')|float}}"
  - service: input_number.set_value
    data_template:
      entity_id: input_number.temperatura_massima_oggi
      value: "0"
      
#Pioggia di Oggi
- id: pioggia_oggi
  alias: Pioggia di Oggi
  trigger:
  - platform: time_pattern
    hours: "/1"
  action:
  - service: input_number.set_value
    data_template:
      entity_id: input_number.pioggia_oggi
      value: "{{ states('input_number.pioggia_oggi')|float + states('sensor.meteo_openweathermap_forecast_precipitation'|float)}}"
      
#Pioggia di Ieri
- id: pioggia_ieri
  alias: Pioggia di Ieri
  trigger:
  - platform: time
    at: "23:59:00"
  action:
  - service: input_number.set_value
    data_template:
      entity_id: input_number.pioggia_ieri
      value: "{{ states('sensor.meteo_openweathermap_rain')|float}}"
  - service: input_number.set_value
    data_template:
      entity_id: input_number.pioggia_oggi
      value: "0"
